import{__awaiter as e,__generator as t}from'./../../../../ext/tslib/tslib.es6.js';import{saveRaffleParticipant as r}from"@ikas/storefront-api";import{makeObservable as a,computed as i,observable as s,action as o}from"mobx";import{Validator as n}from"../index.js";import{IkasBaseStore as l}from"../../../../store/base.js";import"../../../../store/customer/index.js";import"../../../../store/cart/index.js";import{RequiredRule as u,EmailRule as m,PhoneRule as d,MinRule as f,MaxRule as h,IdentityNumberRule as c}from"../rules/index.js";var b=function(){function b(e){var t,r,b,p=this;this.model={firstName:(null===(t=l.getInstance().customerStore.customer)||void 0===t?void 0:t.firstName)||"",lastName:(null===(r=l.getInstance().customerStore.customer)||void 0===r?void 0:r.lastName)||"",email:(null===(b=l.getInstance().customerStore.customer)||void 0===b?void 0:b.email)||"",extraData:{birthYear:null,identityNumber:null},phone:""},this.onFirstNameChange=function(e){p.firstName=e},this.onLastNameChange=function(e){p.lastName=e},this.onEmailChange=function(e){p.email=e},this.onBirthYearChange=function(e){p.birthYear=e},this.onIdentityNumberChange=function(e){p.identityNumber=e},this.onPhoneChange=function(e){p.phone=e},a(this,{emailErrorMessage:i,firstNameErrorMessage:i,lastNameErrorMessage:i,birthYearErrorMessage:i,identityNumberErrorMessage:i,hasValidatorError:i,results:i,redirect:i,model:s,validateAll:o}),this.raffle=e.raffle,this.validator=new n(this.model,[new u({fieldKey:"firstName",valuePath:"firstName",message:e.message.requiredRule}),new u({fieldKey:"lastName",valuePath:"lastName",message:e.message.requiredRule}),new u({fieldKey:"email",valuePath:"email",message:e.message.requiredRule}),new u({fieldKey:"birthYear",valuePath:"extraData.birthYear",message:e.message.requiredRule}),new u({fieldKey:"identityNumber",valuePath:"extraData.identityNumber",message:e.message.requiredRule}),new m({fieldKey:"email",valuePath:"email",message:e.message.emailRule}),new d({fieldKey:"phone",valuePath:"phone",message:e.message.phoneRule}),new f({fieldKey:"birthYear",valuePath:"extraData.birthYear",message:e.message.birthdayRule,minValue:1e3}),new h({fieldKey:"birthYear",valuePath:"extraData.birthYear",message:e.message.birthdayRule,maxValue:9999}),new c({fieldKey:"identityNumber",valuePath:"extraData.identityNumber",message:e.message.identityNumberRule})])}return Object.defineProperty(b.prototype,"firstName",{get:function(){return this.model.firstName},set:function(e){this.model.firstName=e},enumerable:!1,configurable:!0}),Object.defineProperty(b.prototype,"lastName",{get:function(){return this.model.lastName},set:function(e){this.model.lastName=e},enumerable:!1,configurable:!0}),Object.defineProperty(b.prototype,"email",{get:function(){return this.model.email},set:function(e){this.model.email=e},enumerable:!1,configurable:!0}),Object.defineProperty(b.prototype,"birthYear",{get:function(){return this.model.extraData.birthYear},set:function(e){this.model.extraData.birthYear=e},enumerable:!1,configurable:!0}),Object.defineProperty(b.prototype,"identityNumber",{get:function(){return this.model.extraData.identityNumber},set:function(e){this.model.extraData.identityNumber=e},enumerable:!1,configurable:!0}),Object.defineProperty(b.prototype,"phone",{get:function(){return this.model.phone},set:function(e){this.model.phone=e},enumerable:!1,configurable:!0}),Object.defineProperty(b.prototype,"firstNameErrorMessage",{get:function(){return this.validator.results.firstName.errorMessage},enumerable:!1,configurable:!0}),Object.defineProperty(b.prototype,"lastNameErrorMessage",{get:function(){return this.validator.results.lastName.errorMessage},enumerable:!1,configurable:!0}),Object.defineProperty(b.prototype,"emailErrorMessage",{get:function(){return this.validator.results.email.errorMessage},enumerable:!1,configurable:!0}),Object.defineProperty(b.prototype,"birthYearErrorMessage",{get:function(){return this.validator.results.birthYear.errorMessage},enumerable:!1,configurable:!0}),Object.defineProperty(b.prototype,"identityNumberErrorMessage",{get:function(){return this.validator.results.identityNumber.errorMessage},enumerable:!1,configurable:!0}),Object.defineProperty(b.prototype,"phoneErrorMessage",{get:function(){return this.validator.results.phone.errorMessage},enumerable:!1,configurable:!0}),Object.defineProperty(b.prototype,"redirect",{get:function(){if("undefined"!=typeof window)return new URLSearchParams(window.location.search).get("redirect")},enumerable:!1,configurable:!0}),Object.defineProperty(b.prototype,"hasValidatorError",{get:function(){var e;return this.validator.hasError||!(null===(e=this.raffle.variants)||void 0===e?void 0:e.length)},enumerable:!1,configurable:!0}),Object.defineProperty(b.prototype,"results",{get:function(){return this.validator.results},enumerable:!1,configurable:!0}),b.prototype.validateAll=function(){return this.validator.validateAll()},b.prototype.submit=function(){return e(this,void 0,void 0,(function(){var e,a,i,s;return t(this,(function(t){switch(t.label){case 0:return e={isFormError:!1,isSuccess:!1},[4,this.validateAll()];case 1:if(t.sent())return e.isFormError=!0,[2,e];t.label=2;case 2:return t.trys.push([2,4,,5]),a=this.raffle.products[0].selectedVariant,[4,r({input:{appliedProduct:{productId:a.productId,variantId:a.id},email:this.email,firstName:this.firstName,lastName:this.lastName,raffleId:this.raffle.id,extraData:{birthYear:this.birthYear,identityNumber:this.identityNumber},phone:this.phone}})];case 3:return(null==(i=t.sent())?void 0:i.graphQLErrors)&&(e.errors=i.graphQLErrors,e.isSuccess=!1),i.data&&(e.isSuccess=!0),[2,e];case 4:return(s=t.sent())&&(e.errors=s),[2,e];case 5:return[2]}}))}))},b}();export{b as RaffleForm};
