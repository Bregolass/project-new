import{__awaiter as e,__generator as r}from'./../../../ext/tslib/tslib.es6.js';import{makeAutoObservable as t}from"mobx";import s from"lodash/groupBy";var n=function(){function n(e,r){var s=this;this.results={},this.onValueChange=function(e){var r=s.results[e.fieldKey];r&&"error"===r.status&&s.runRules(e.fieldKey,[e])},this.model=e,this.rules=[],this.setRules(r),t(this,{model:!1})}return Object.defineProperty(n.prototype,"hasError",{get:function(){return Object.values(this.results).some((function(e){return"error"===e.status}))},enumerable:!1,configurable:!0}),n.prototype.setRules=function(e){var r=this;this.rules.forEach((function(e){return e.disposer&&e.disposer()})),this.rules=e,this.rules.forEach((function(e){r.results[e.fieldKey]=new i(e.fieldKey),e.model=r.model,e.onValueChange=r.onValueChange}));var t=[];Object.keys(this.results).forEach((function(e){r.rules.some((function(r){return r.fieldKey===e}))||t.push(e)})),t.forEach((function(e){delete r.results[e]}))},n.prototype.validateAll=function(){return e(this,void 0,void 0,(function(){var e,t,n,i,o;return r(this,(function(r){switch(r.label){case 0:e=s(this.rules,"fieldKey"),t=Object.keys(e),n=0,r.label=1;case 1:return n<t.length?(i=t[n],o=e[i],[4,this.runRules(i,o)]):[3,4];case 2:r.sent(),r.label=3;case 3:return n++,[3,1];case 4:return[2,this.hasError]}}))}))},n.prototype.validateFieldRules=function(t){return e(this,void 0,void 0,(function(){var e;return r(this,(function(r){switch(r.label){case 0:return e=this.rules.filter((function(e){return e.fieldKey===t})),[4,this.runRules(t,e)];case 1:return r.sent(),[2]}}))}))},n.prototype.runRules=function(t,s){return e(this,void 0,void 0,(function(){var e,n,i,o,u;return r(this,(function(r){switch(r.label){case 0:e=[],n=[],i=!1,o=0,r.label=1;case 1:return o<s.length?[4,(u=s[o]).run()]:[3,4];case 2:r.sent()||(i=!0,u.errorType&&e.push(u.errorType),n.push(u.errorMessage)),r.label=3;case 3:return o++,[3,1];case 4:return this.results[t]&&(this.results[t].errorTypes=e,this.results[t].messages=n,this.results[t].status=i?"error":void 0),[2]}}))}))},n}(),i=function(){function e(e,r,s,n){void 0===s&&(s=[]),void 0===n&&(n=[]),this.fieldKey=e,this.status=r,this.messages=s,this.errorTypes=n,t(this)}return Object.defineProperty(e.prototype,"errorMessage",{get:function(){return this.messages.length?this.messages[0]:void 0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"errorType",{get:function(){return this.errorTypes.length?this.errorTypes[0]:void 0},enumerable:!1,configurable:!0}),e}();export{n as Validator};
