import{__awaiter as e,__generator as r,__assign as o}from'../ext/tslib/tslib.es6.js';import n from"axios";import t from"../config/index.js";import{APIResponse as a}from"./api.js";import{generateGqlReturnFields as i}from"../helpers/generate-return-fields.js";var s=function(l){var R=l.operationName,u=l.variables,c=l.allReturnFields,d=l.fields,f=l.query,p=l.config;return e(void 0,void 0,void 0,(function(){var l,E,O,N,m,v,h,b,_;return r(this,(function(g){switch(g.label){case 0:return l=d?i(d):c,E=p?{URL:p.URL||t.URL,TOKEN:p.TOKEN||t.TOKEN,HEADERS:p.HEADERS||t.HEADERS,ON_ERROR:p.ON_ERROR||t.ON_ERROR}:t,O={"Content-Type":"application/json"},E.TOKEN&&(O.authorization="Bearer ".concat(E.TOKEN)),[4,n.post(E.URL+"?op=".concat(R),{query:"string"==typeof f?f:f(l),variables:o({},u)},{headers:o(o({},O),E.HEADERS)})];case 1:return N=g.sent(),m=N.data.errors,0!==(v=new a(void 0,m)).errorCodes.length&&E.ON_ERROR?(h=!1,E.ON_ERROR.operations&&E.ON_ERROR.operations.length&&(b=null===(_=E.ON_ERROR.operations)||void 0===_?void 0:_.find((function(e){return e.operationName===R})))?[4,b.callback({graphQLErrors:m,operationName:R})]:[3,3]):[3,7];case 2:g.sent(),b.refreshQuery&&(h=!0),g.label=3;case 3:return E.ON_ERROR.errorCodes&&E.ON_ERROR.errorCodes.length?[4,Promise.all(v.errorCodes.map((function(o){return e(void 0,void 0,void 0,(function(){var e,n;return r(this,(function(r){switch(r.label){case 0:return(e=null===(n=E.ON_ERROR.errorCodes)||void 0===n?void 0:n.find((function(e){return e.errorCode===o})))?(h=h||!!e.refreshQuery,[4,e.callback({graphQLErrors:m,operationName:R})]):[3,2];case 1:r.sent(),r.label=2;case 2:return[2]}}))}))})))]:[3,5];case 4:g.sent(),g.label=5;case 5:return h?[4,s({operationName:R,variables:u,allReturnFields:c,fields:d,query:f,config:p})]:[3,7];case 6:return[2,g.sent()];case 7:return[2,N.data]}}))}))};export{s as default};
