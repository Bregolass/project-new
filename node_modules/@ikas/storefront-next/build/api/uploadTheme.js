import{__awaiter as e,__generator as r}from'./../ext/tslib/tslib.es6.js';import t from"fs";import n from"path";import o from"adm-zip";import s from"axios";import i from"@ikas/storefront-assets/checkout/de.js";import c from"@ikas/storefront-assets/checkout/en.js";import a from"@ikas/storefront-assets/checkout/tr.js";import{corsMiddleware as u}from"./middleware.js";var l=function(s,l){return e(void 0,void 0,void 0,(function(){var e,d,m,y,v,g,S,w,j;return r(this,(function(r){switch(r.label){case 0:return[4,u(s,l)];case 1:r.sent(),e=function(){l.statusCode=200,l.setHeader("Content-Type","application/json"),l.json({status:"ok"})},d=function(){l.statusCode=400,l.setHeader("Content-Type","application/json"),l.json({status:"failed"})},m="",r.label=2;case 2:return r.trys.push([2,9,10,11]),[4,new Promise((function(e,r){var o=n.join(process.cwd(),"src","theme.json");t.readFile(o,(function(t,n){if(t)return console.error("An error occurred while reading the theme.json file!"),r(t);e(JSON.parse(n.toString()))}))}))];case 3:return y=r.sent(),[4,new Promise((function(e,r){var o=n.join(process.cwd(),"public","locales"),s=function(e){return e.length?e.split(".")[0]:e};t.readdir(o,(function(u,l){if(u)return r(u);var d=l.filter((function(e){return t.lstatSync(n.join(o,e)).isDirectory()})),h={},p=!1;d.forEach((function(e){var r=n.join(process.cwd(),"public","locales",e);h[e]={};try{var o=t.readdirSync(r);o.forEach((function(r){var o=t.readFileSync(n.join(process.cwd(),"public","locales",e,r)),u=s(e).toLowerCase(),l=s(r);h[u][l]=JSON.parse(o.toString()),h[u]["checkout-page"]="tr"===u?a:"de"===u?i:c}))}catch(e){console.error("An error occurred while reading localization files!"),console.error(e),p=!0}})),p?r(null):e(h)}))}))];case 4:return v=r.sent(),[4,h(y,v)];case 5:return g=r.sent(),S=!1,"string"!=typeof g?[3,8]:(b=n.join(process.cwd()),T="theme.zip",N=n.join(process.cwd(),T),L=new o,C=["node_modules",".next","out",".git"],t.readdirSync(b).forEach((function(e){var r=n.join(b,e);if(t.lstatSync(r).isDirectory()){if(C.includes(e))return;L.addLocalFolder(r,e)}else L.addLocalFile(e)})),L.writeZip(N),m=N,w=t.statSync(m),[4,p(g,t.readFileSync(m),w.size)]);case 6:return(S=r.sent())?[4,f()]:[3,8];case 7:S=r.sent(),r.label=8;case 8:return S?e():d(),[3,11];case 9:return j=r.sent(),console.error(j),d(),[3,11];case 10:return m&&function(e){try{t.unlinkSync(e)}catch(e){console.error("An error occurrred while deleting the zip file!"),console.error(e)}}(m),[7];case 11:return[2]}var b,T,N,L,C}))}))},d={};function h(t,n){return e(this,void 0,void 0,(function(){var e,o,i,c,a;return r(this,(function(r){switch(r.label){case 0:return r.trys.push([0,4,,5]),e=Object.keys(n),o=e.some((function(e){return"en"===e}))?"en":e[0],[4,m()];case 1:return i=r.sent(),[4,s({method:"post",url:process.env.NEXT_PUBLIC_PARTNER_GQL_URL,headers:{"x-api-key":i.apiKey,"Content-Type":"application/json"},data:JSON.stringify({query:"\n          mutation createNewThemeVersion($input: CreateNewThemeVersionInput!) {\n            createNewThemeVersion(input: $input) {\n              themeVersionId\n              uploadUrl\n            }\n          }\n        ",variables:{input:{themeId:i.themeId,themeSecret:i.themeSecret,themeJson:JSON.stringify(t),locales:Object.entries(n).map((function(e){var r=e[0],t=e[1];return{isDefaultLocale:r===o,locale:r,localeJson:JSON.stringify(t)}}))}}})})];case 2:return[4,r.sent().data];case 3:return(c=r.sent()).data&&c.data.createNewThemeVersion?[2,c.data.createNewThemeVersion.uploadUrl]:[3,5];case 4:return a=r.sent(),console.error("An error occurred during saveTheme!"),console.log(a),[3,5];case 5:return[2]}}))}))}function p(t,n,o){return e(this,void 0,void 0,(function(){var e,i;return r(this,(function(r){switch(r.label){case 0:e={headers:{"Content-Type":"application/zip","Content-Length":o+""},maxBodyLength:104857600,maxContentLength:104857600},r.label=1;case 1:return r.trys.push([1,3,,4]),[4,s.put(t,n,e)];case 2:return[2,200===r.sent().status];case 3:return i=r.sent(),console.error("An error occurred during uploadTheme!"),console.log(i),[2,!1];case 4:return[2]}}))}))}function f(){return e(this,void 0,void 0,(function(){var e,t;return r(this,(function(r){switch(r.label){case 0:return r.trys.push([0,4,,5]),[4,m()];case 1:return e=r.sent(),[4,fetch(process.env.NEXT_PUBLIC_PARTNER_GQL_URL,{method:"POST",body:JSON.stringify({query:"\n          mutation buildThemeLatestVersion(\n            $themeSecret: String!\n            $themeId: String!\n          ) {\n            buildThemeLatestVersion(\n              themeSecret: $themeSecret\n              themeId: $themeId\n            )\n          }\n        ",variables:{themeSecret:e.themeSecret,themeId:e.themeId}}),headers:{"x-api-key":e.apiKey,"Content-Type":"application/json"}})];case 2:return[4,r.sent().json()];case 3:return r.sent(),[2,!0];case 4:return t=r.sent(),console.error("An error occurred during buildTheme!"),console.log(t),[2,!1];case 5:return[2]}}))}))}function m(){return new Promise((function(e,r){var o=n.join(process.cwd(),"config.json");t.readFile(o,(function(t,n){if(t)return console.error("An error occurred while reading the storefront config!"),r(t);e(JSON.parse(n.toString()))}))}))}export{d as config,l as uploadTheme};
